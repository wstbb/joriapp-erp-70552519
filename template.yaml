AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  智汇-ERP后端 (zhihui-erp-backend) V5 - 已集成SaaS后台管理API

  一个为多租户ERP系统设计的、采用现代HTTP API架构的SAM模板。

Globals:
  Function:
    Timeout: 31
    MemorySize: 256
    Runtime: python3.11
    Architectures:
      - x86_64

Parameters:
  DBName:
    Type: String
    Default: jori_erp_db
    Description: The name for the RDS PostgreSQL database.
  DBUser:
    Type: String
    Default: postgres
    Description: Master username for the RDS database.
  DBPassword:
    Type: String
    Default: test1234
    NoEcho: true
    Description: Master password for the RDS database.

Resources:
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      Tags:
        - Key: Name
          Value: 智汇ERP-前端存储桶

  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: "*"
            Action:
              - s3:GetObject
            Resource: !Sub "arn:aws:s3:::${FrontendBucket}/*"

  ZhiHuiErpHttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        AllowOrigins:
          - "*"
        AllowHeaders:
          - "Content-Type"
          - "Authorization"
        AllowMethods:
          - "GET"
          - "POST"
          - "OPTIONS"
          - "PUT"
          - "DELETE"

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: 智汇ERP-VPC

  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: 智汇ERP-公共子网A

  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      Tags:
        - Key: Name
          Value: 智汇ERP-私有子网A

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: 智汇ERP-公共子网B

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      Tags:
        - Key: Name
          Value: 智汇ERP-私有子网B

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: 智汇ERP-互联网网关

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  NatGatewayEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnetA
      Tags:
        - Key: Name
          Value: 智汇ERP-NAT网关

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: 智汇ERP-公共路由表

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: 智汇ERP-私有路由表

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTable

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group for Lambda functions"
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: 智汇ERP-Lambda安全组

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group for the RDS instance"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
      Tags:
        - Key: Name
          Value: 智汇ERP-Rds安全组
  
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: "Subnet group for the RDS instance, covering multiple AZs"
      SubnetIds:
        - !Ref PrivateSubnetA
        - !Ref PrivateSubnetB

  DBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBName: !Ref DBName
      Engine: postgres
      EngineVersion: '15'
      DBInstanceClass: db.t3.micro
      AllocatedStorage: '20'
      MasterUsername: !Ref DBUser
      MasterUserPassword: !Ref DBPassword
      PubliclyAccessible: false
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      MultiAZ: true
      Tags:
        - Key: Name
          Value: 智汇ERP-DB实例

  SuperAdminSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Description: "Super admin credentials for the ERP backend"
      SecretString: !Sub '{"username": "superadmin", "password": "test1234"}'

  DatabaseUtilsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: zhihui-erp-db-utils-layer
      Description: "Shared utilities layer for database connections [FORCED UPDATE V13]"
      ContentUri: backend/lambda/layers/database_utils
      CompatibleRuntimes:
        - python3.11
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: python3.11

  DbSetupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: erp-db-setup-function
      CodeUri: backend/lambda/db_setup_assets/
      Handler: db_setup.handler
      Layers:
        - !Ref DatabaseUtilsLayer
      Policies:
        - VPCAccessPolicy: {}
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnetA
          - !Ref PrivateSubnetB
      Environment:
        Variables:
          DB_HOST: !GetAtt DBInstance.Endpoint.Address
          DB_PORT: !GetAtt DBInstance.Endpoint.Port
          DB_NAME: !Ref DBName
          DB_USER: !Ref DBUser
          DB_PASSWORD: !Ref DBPassword

  DbSetupInvokerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: erp-db-setup-invoker
      CodeUri: backend/lambda/db_setup_invoker/
      Handler: db_setup_invoker.handler
      Runtime: python3.11
      Timeout: 120
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action: lambda:InvokeFunction
              Resource: !Sub "${DbSetupFunction.Arn}"

  DbSetupInvokerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DbSetupInvokerFunction
      Action: lambda:InvokeFunction
      Principal: cloudformation.amazonaws.com

  DbSetupCustomResource:
    Type: Custom::DbSetup
    DependsOn:
      - DbSetupFunction
      - DBInstance
    Properties:
      ServiceToken: !GetAtt DbSetupInvokerFunction.Arn
      DbSetupFunctionName: !Ref DbSetupFunction

  AuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: erp-auth-function
      CodeUri: backend/lambda/auth/
      Handler: auth.handler
      Layers:
        - !Ref DatabaseUtilsLayer
      Policies:
        - VPCAccessPolicy: {}
        - SecretsManagerReadWrite
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnetA
          - !Ref PrivateSubnetB
      Environment:
        Variables:
          DB_HOST: !GetAtt DBInstance.Endpoint.Address
          DB_PORT: !GetAtt DBInstance.Endpoint.Port
          DB_NAME: !Ref DBName
          DB_USER: !Ref DBUser
          DB_PASSWORD: !Ref DBPassword
          JWT_SECRET: f86b817fd2727c45e842a4bd55855dae2b91b10e29bc7e6dc33ff4024e048ebd
          SUPER_ADMIN_SECRET_ARN: !Ref SuperAdminSecret
      Events:
        LoginApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/auth/login
            Method: POST

  SaasAdminFunction: # <--- 新增的后台管理函数
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: erp-saas-admin-function
      CodeUri: backend/lambda/saas_admin/
      Handler: main.handler
      Layers:
        - !Ref DatabaseUtilsLayer
      Policies:
        - VPCAccessPolicy: {}
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnetA
          - !Ref PrivateSubnetB
      Environment:
        Variables:
          DB_HOST: !GetAtt DBInstance.Endpoint.Address
          DB_PORT: !GetAtt DBInstance.Endpoint.Port
          DB_NAME: !Ref DBName
          DB_USER: !Ref DBUser
          DB_PASSWORD: !Ref DBPassword
          JWT_SECRET: f86b817fd2727c45e842a4bd55855dae2b91b10e29bc7e6dc33ff4024e048ebd
      Events:
        AdminApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /admin/{proxy+}
            Method: ANY

  TenantsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: erp-tenants-function
      CodeUri: backend/lambda/tenants/
      Handler: tenants.handler
      Layers:
        - !Ref DatabaseUtilsLayer
      Policies:
        - VPCAccessPolicy: {}
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnetA
          - !Ref PrivateSubnetB
      Environment:
        Variables:
          DB_HOST: !GetAtt DBInstance.Endpoint.Address
          DB_PORT: !GetAtt DBInstance.Endpoint.Port
          DB_NAME: !Ref DBName
          DB_USER: !Ref DBUser
          DB_PASSWORD: !Ref DBPassword
          JWT_SECRET: f86b817fd2727c45e842a4bd55855dae2b91b10e29bc7e6dc33ff4024e048ebd
      Events:
        GetTenantsApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/tenants
            Method: GET
        CreateTenantApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/tenants
            Method: POST
        UpdateTenantStatusApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/tenants/{tenantId}/status
            Method: PUT
        UpdateTenantPlanApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/tenants/{tenantId}/plan
            Method: PUT
        ResetAdminPasswordApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/tenants/{tenantId}/reset-password
            Method: POST
        GetTenantUsageApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/tenants/{tenantId}/usage
            Method: GET
        GetTenantHistoryApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/tenants/{tenantId}/history
            Method: GET
        ProvisionSubdomainApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/tenants/{tenantId}/provision-subdomain
            Method: POST
        DeleteTenantApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/tenants/{tenantId}
            Method: DELETE

  UsersFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: erp-users-function
      CodeUri: backend/lambda/users/
      Handler: users.handler
      Layers:
        - !Ref DatabaseUtilsLayer
      Policies:
        - VPCAccessPolicy: {}
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnetA
          - !Ref PrivateSubnetB
      Environment:
        Variables:
          DB_HOST: !GetAtt DBInstance.Endpoint.Address
          DB_PORT: !GetAtt DBInstance.Endpoint.Port
          DB_NAME: !Ref DBName
          DB_USER: !Ref DBUser
          DB_PASSWORD: !Ref DBPassword
          JWT_SECRET: f86b817fd2727c45e842a4bd55855dae2b91b10e29bc7e6dc33ff4024e048ebd
      Events:
        ListUsersApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/users
            Method: GET
        CreateUserApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/users
            Method: POST
        GetUserApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/users/{userId}
            Method: GET

  TicketsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: erp-tickets-function
      CodeUri: backend/lambda/tickets/
      Handler: tickets.handler
      Layers:
        - !Ref DatabaseUtilsLayer
      Policies:
        - VPCAccessPolicy: {}
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnetA
          - !Ref PrivateSubnetB
      Environment:
        Variables:
          DB_HOST: !GetAtt DBInstance.Endpoint.Address
          DB_PORT: !GetAtt DBInstance.Endpoint.Port
          DB_NAME: !Ref DBName
          DB_USER: !Ref DBUser
          DB_PASSWORD: !Ref DBPassword
          JWT_SECRET: f86b817fd2727c45e842a4bd55855dae2b91b10e29bc7e6dc33ff4024e048ebd
      Events:
        TicketsListCreateApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/tickets
            Method: ANY
        TicketsDetailApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/tickets/{proxy+}
            Method: ANY

  DebugDbDumpFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: erp-debug-db-dump-function
      CodeUri: backend/lambda/debug_dump/
      Handler: debug_dump.handler
      Layers:
        - !Ref DatabaseUtilsLayer
      Policies:
        - VPCAccessPolicy: {}
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnetA
          - !Ref PrivateSubnetB
      Environment:
        Variables:
          DB_HOST: !GetAtt DBInstance.Endpoint.Address
          DB_PORT: !GetAtt DBInstance.Endpoint.Port
          DB_NAME: !Ref DBName
          DB_USER: !Ref DBUser
          DB_PASSWORD: !Ref DBPassword
          JWT_SECRET: f86b817fd2727c45e842a4bd55855dae2b91b10e29bc7e6dc33ff4024e048ebd
      Events:
        DumpApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref ZhiHuiErpHttpApi
            Path: /api/debug/dump
            Method: GET

Outputs:
  ApiGatewayEndpoint:
    Description: "Root endpoint URL for the HTTP API Gateway"
    Value: !Sub "https://${ZhiHuiErpHttpApi}.execute-api.${AWS::Region}.amazonaws.com"
  DbSetupFunctionName:
    Description: "Name of the DbSetup Lambda function"
    Value: !Ref DbSetupFunction
  DBEndpoint:
    Description: "Endpoint address of the RDS instance"
    Value: !GetAtt DBInstance.Endpoint.Address
  FrontendBucketName:
    Description: "Name of the S3 bucket for the frontend application"
    Value: !Ref FrontendBucket
  FrontendURL:
    Description: "URL for the hosted frontend application"
    Value: !GetAtt FrontendBucket.WebsiteURL
